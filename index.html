<!DOCTYPE html>
<html>
<head>
  <title>OSM Map Simulation (Named for Your Files)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 90vh; width: 100vw; }
    #info { position: absolute; top: 10px; left: 10px; z-index: 1000; background: #fff; padding: 8px; border-radius: 8px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info"><b>Loading...</b></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var map = L.map('map').setView([28.6, 77.2], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

    var infoDiv = document.getElementById('info');

    // 1. Add lines.geojson roads (blue)
    let routeCoords = [];
    fetch('lines.geojson')
      .then(r => r.json())
      .then(geojson => {
        L.geoJSON(geojson, {color: 'blue'}).addTo(map);
        // Extract a short demo route from the first few lines
        geojson.features.forEach(f=>{
          if(f.geometry.type === "LineString"){
            // Use first 4 points from the first linestring found
            if(routeCoords.length<4) routeCoords = routeCoords.concat(f.geometry.coordinates.slice(0,4));
          }
        });
        if(routeCoords.length<2) routeCoords = [[77.2,28.6],[77.21,28.61],[77.23,28.62],[77.25,28.65]];
        animateCar(routeCoords.map(pt=>[pt[1],pt[0]])); // [lat, lng]
      });

    // 2. Add multilinestrings.geojson (dashed orange, for complex roads)
    fetch('multilinestrings.geojson')
      .then(r => r.json())
      .then(geojson => {
        L.geoJSON(geojson, {
          style: {color:'orange', dashArray:'4'}
        }).addTo(map);
      });

    // 3. Add multipolygons.geojson (green fill, e.g., parks or large zones)
    fetch('multipolygons.geojson')
      .then(r => r.json())
      .then(geojson => {
        L.geoJSON(geojson, {
          style:{color:'green', fillColor:'#7f7', fillOpacity:0.2}
        }).addTo(map);
      });

    // 4. Add points.geojson (red for schools or POIs)
    let poiPoints = [];
    fetch('points.geojson')
      .then(r => r.json())
      .then(geojson => {
        L.geoJSON(geojson, {
          pointToLayer: function(f,latlng){
            // Mark all as POI; if type is "school", remember for school zone check
            let color = 'red';
            if(f.properties && f.properties.amenity==="school") poiPoints.push(latlng);
            else poiPoints.push(latlng); // Mark all for demo; edit this for actual filtering.
            return L.circleMarker(latlng,{radius:7, color:color, fillColor:'#f88', fillOpacity:0.8});
          }
        }).addTo(map);
      });

    // Distance helper
    function dist(a, b){
      const toRad = x => x * Math.PI / 180, R = 6371000;
      const dLat=toRad(b[0]-a[0]), dLng=toRad(b[1]-a[1]), x1=toRad(a[0]), x2=toRad(b[0]);
      const aVal = Math.sin(dLat/2)**2 + Math.cos(x1)*Math.cos(x2)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(aVal));
    }

    // Car animation
    function animateCar(route){
      var carMarker = L.marker(route[0],{
        icon: L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/1783/1783337.png",
          iconSize: [32,32], iconAnchor:[16,16]
        })
      }).addTo(map);

      var idx = 0, SPEED_OUT=100, SPEED_SCHOOL=20, curSpeed=SPEED_OUT, stepDist=5;
      function nextStep(){
        if(idx >= route.length-1) return;
        let pos = carMarker.getLatLng();
        let nxt = route[idx+1];
        let segDist = dist([pos.lat,pos.lng], nxt);
        let moveFrac = Math.min(stepDist/segDist,1);
        let lat = pos.lat + (nxt[0]-pos.lat)*moveFrac;
        let lng = pos.lng + (nxt[1]-pos.lng)*moveFrac;
        let here = [lat,lng];

        // Find distance to any POI (demo: treat all points as schools; customize as needed)
        let minDist = 9999;
        for(let k=0;k<poiPoints.length;k++){
          let d = dist(here, [poiPoints[k].lat, poiPoints[k].lng]);
          if(d<minDist) minDist=d;
        }
        let inSchoolZone = minDist<100; // 100m school zone
        curSpeed = inSchoolZone ? SPEED_SCHOOL : SPEED_OUT;

        infoDiv.innerHTML = `<b>Position:</b> ${lat.toFixed(5)}, ${lng.toFixed(5)}<br>
          <b>Speed Limit:</b> ${curSpeed} km/h<br>
          <b>${inSchoolZone?'In <span style="color:red">School Zone</span>':'Normal Zone'}</b><br>
          <b>Distance to nearest POI:</b> ${Math.floor(minDist)} m`;

        carMarker.setLatLng(here);
        map.panTo(here);
        if(moveFrac===1) idx++;
        setTimeout(nextStep, inSchoolZone?300:80);
      }
      nextStep();
    }
  </script>
</body>
</html>
