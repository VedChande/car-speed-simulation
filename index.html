<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Car Speed Simulation - Specific School</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100vw; }
    #info {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 1000;
      background: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 14px;
      max-width: 280px;
    }
  </style>
</head>
<body>
  
  <div id="map"></div>
  <div id="info"><b>Loading map and route...</b></div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  <script>
    // Initialize map centered near your route/school location
    var mapCenter = [19.06, 72.845]; // Adjust if needed
    var map = L.map('map').setView(mapCenter, 14);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    var infoDiv = document.getElementById('info');

    // Mark ONLY your specific school location:
    var schoolLatLng = [19.063607719563397, 72.8462002686538];
    var schoolMarker = L.circleMarker(schoolLatLng, {
      radius: 10,
      color: 'red',
      fillColor: '#f88',
      fillOpacity: 0.95
    }).addTo(map).bindPopup('School');

    // For school zone detection:
    var schoolPoint = L.latLng(schoolLatLng[0], schoolLatLng[1]);

    // Helper to calculate distance in meters between points (Leaflet built-in)
    function distanceMeters(a, b) {
      return map.distance(a, b);
    }

    // Array to hold route coordinates (lat,lng)
    var routeCoords = [];

    // Load your lines.geojson that contains roads
    fetch('lines.geojson')
      .then(res => res.json())
      .then(data => {
        // Add roads to map in blue
        L.geoJSON(data, { color: 'blue' }).addTo(map);

        // Extract first 4 points from first suitable LineString feature for route
        var foundRoute = false;
        for(let feature of data.features){
          if(feature.geometry.type === 'LineString' && feature.geometry.coordinates.length >= 4){
            // GeoJSON coordinates are [lng, lat], convert to [lat, lng] for Leaflet
            routeCoords = feature.geometry.coordinates.slice(0, 4).map(coord => [coord[1], coord[0]]);
            foundRoute = true;
            break;
          }
        }
        if(!foundRoute) {
          // Fallback route if lines.geojson is empty or no LineString found
          routeCoords = [
            [19.06, 72.84], 
            [19.061, 72.842], 
            [19.062, 72.844], 
            [19.063, 72.846]
          ];
        }

        startCarAnimation(routeCoords);
        infoDiv.innerHTML = 'Simulation started!';
      })
      .catch(() => {
        infoDiv.innerHTML = 'Failed to load lines.geojson.';
      });

    // Car animation along route
    function startCarAnimation(route) {
      var carIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1783/1783337.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16],
      });

      var carMarker = L.marker(route[0], { icon: carIcon }).addTo(map);

      var idx = 0;
      var SPEED_OUT = 100;      // km/h outside school
      var SPEED_SCHOOL = 20;    // km/h inside school zone
      var currentSpeed = SPEED_OUT;
      var stepDistanceMeters = 5; // movement per interval in meters

      function animateStep() {
        if (idx >= route.length - 1) {
          infoDiv.innerHTML += '<br><b>Route completed.</b>';
          return;
        }

        var pos = carMarker.getLatLng();
        var next = L.latLng(route[idx + 1]);

        var distToNext = pos.distanceTo(next);
        var moveFraction = Math.min(stepDistanceMeters / distToNext, 1);

        var lat = pos.lat + (next.lat - pos.lat) * moveFraction;
        var lng = pos.lng + (next.lng - pos.lng) * moveFraction;
        var newPos = L.latLng(lat, lng);

        // Distance to the school location
        var distToSchool = newPos.distanceTo(schoolPoint);
        var inSchoolZone = distToSchool <= 100; // 100 meters radius

        currentSpeed = inSchoolZone ? SPEED_SCHOOL : SPEED_OUT;

        // Update info panel
        infoDiv.innerHTML = 
          `<b>Position:</b> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>` +
          `<b>Speed Limit:</b> ${currentSpeed} km/h<br>` +
          `<b>Status:</b> ${inSchoolZone ? '<span style="color:red;">In School Zone</span>' : 'Normal Area'}<br>` +
          `<b>Distance to school:</b> ${Math.round(distToSchool)} meters`;

        carMarker.setLatLng(newPos);
        map.panTo(newPos);

        if (moveFraction === 1) {
          idx++;
        }

        // Slower update interval if in school zone (simulate slower speed)
        var delay = inSchoolZone ? 300 : 80; // milliseconds

        setTimeout(animateStep, delay);
      }

      animateStep();
    }

  </script>
</body>
</html>
