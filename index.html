<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Car Speed Simulation - Single School Zone</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100vh; width: 100vw; }
    #info {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 1000;
      background: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
      font-size: 15px;
      max-width: 260px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info"><b>Loading map and route...</b></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Map centered near your school
    var map = L.map('map').setView([19.063, 72.846], 15);

    // OSM base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var infoDiv = document.getElementById('info');

    // Only your chosen school, marked as a prominent red circle
    var schoolLatLng = [19.063607719563397, 72.8462002686538];
    var schoolMarker = L.circleMarker(schoolLatLng, {
      radius: 10,
      color: 'red',
      fillColor: '#f88',
      fillOpacity: 0.98
    }).addTo(map).bindPopup('School');

    // For school zone detection
    var schoolPoint = L.latLng(schoolLatLng[0], schoolLatLng[1]);

    // Optionally, add extra visual layers (fillable if you want)
    fetch('multilinestrings.geojson').then(r=>r.json()).then(g=>{
      L.geoJSON(g, { style: { color: 'orange', dashArray: '5 9' }}).addTo(map);
    });
    fetch('multipolygons.geojson').then(r=>r.json()).then(g=>{
      L.geoJSON(g, { style: { color: 'green', fillColor: '#7f7', fillOpacity: 0.18 }}).addTo(map);
    });

    // Get route coordinates from lines.geojson (first LineString, 4 points minimum)
    var routeCoords = [];
    fetch('lines.geojson')
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, { color: 'blue' }).addTo(map);

        let found = false;
        for (let feature of data.features) {
          if (feature.geometry.type === 'LineString' && feature.geometry.coordinates.length >= 4) {
            routeCoords = feature.geometry.coordinates.slice(0, 4).map(pt => [pt[1], pt[0]]);
            found = true;
            break;
          }
        }
        if(!found) { // fallback route if no data
          routeCoords = [
            [19.062, 72.844],
            [19.063, 72.846],
            [19.064, 72.848],
            [19.065, 72.850]
          ];
        }
        startCarAnimation(routeCoords);
        infoDiv.innerHTML = 'Simulation started!';
      })
      .catch(() => { infoDiv.innerHTML = 'Could not load lines.geojson.'; });

    // Animate the car
    function startCarAnimation(route) {
      var carIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1783/1783337.png',
        iconSize: [32, 32], iconAnchor: [16, 16],
      });
      var car = L.marker(route[0], { icon: carIcon }).addTo(map);

      var idx = 0;
      var SPEED_NORMAL = 100;
      var SPEED_SCHOOL = 20;
      var stepDistM = 5;
      var currentSpeed = SPEED_NORMAL;

      function animateStep() {
        if (idx >= route.length - 1) {
          infoDiv.innerHTML += '<br><b>Route completed.</b>';
          return;
        }
        var pos = car.getLatLng();
        var next = L.latLng(route[idx+1]);
        var segDist = pos.distanceTo(next);
        var frac = Math.min(stepDistM / segDist, 1);

        var lat = pos.lat + (next.lat - pos.lat) * frac;
        var lng = pos.lng + (next.lng - pos.lng) * frac;
        var newPos = L.latLng(lat, lng);

        // Only your school for zone logic
        var distToSchool = newPos.distanceTo(schoolPoint);
        var inSchoolZone = distToSchool < 100;
        currentSpeed = inSchoolZone ? SPEED_SCHOOL : SPEED_NORMAL;

        infoDiv.innerHTML =
          `<b>Position:</b> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>` +
          `<b>Speed Limit:</b> ${currentSpeed} km/h<br>` +
          `<b>Status:</b> ${inSchoolZone ? '<span style="color:red">In School Zone</span>' : 'Normal Area'}<br>` +
          `<b>Distance to school:</b> ${Math.round(distToSchool)} m`;

        car.setLatLng(newPos);
        map.panTo(newPos);

        if (frac === 1) idx++;
        setTimeout(animateStep, inSchoolZone ? 300 : 80); // slower in zone, faster outside
      }
      animateStep();
    }
  </script>
</body>
</html>
